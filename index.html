import React, { useState, useEffect } from 'react';
import { MapContainer, TileLayer, Marker, Popup, Polyline, useMap } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import L from 'leaflet';

// 1. áƒ”áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ‘áƒáƒ–áƒ
const translations = {
  ka: { title: "áƒ—áƒ‘áƒ˜áƒšáƒ˜áƒ¡áƒ˜áƒ¡ áƒ¢áƒ áƒáƒœáƒ¡áƒáƒáƒ áƒ¢áƒ˜", search: "áƒ¡áƒáƒ˜áƒ— áƒ›áƒ˜áƒ“áƒ˜áƒ®áƒáƒ áƒ—?", start: "áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒáƒ“áƒ’áƒ˜áƒšáƒ˜", go: "áƒ›áƒáƒ áƒ¨áƒ áƒ£áƒ¢áƒ˜", min: "áƒ¬áƒ—", findMe: "áƒ©áƒ”áƒ›áƒ˜ áƒšáƒáƒ™áƒáƒªáƒ˜áƒ" },
  en: { title: "Tbilisi Transport", search: "Where to?", start: "Your Location", go: "Route", min: "min", findMe: "Find Me" },
  ru: { title: "Ğ¢Ğ±Ğ¸Ğ»Ğ¸ÑÑĞºĞ¸Ğ¹ Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚", search: "ĞšÑƒĞ´Ğ° ĞµĞ´ĞµĞ¼?", start: "Ğ’Ñ‹ Ğ·Ğ´ĞµÑÑŒ", go: "ĞŸÑƒÑ‚ÑŒ", min: "Ğ¼Ğ¸Ğ½", findMe: "Ğ“Ğ´Ğµ Ñ?" }
};

// áƒ™áƒáƒ›áƒáƒáƒœáƒ”áƒœáƒ¢áƒ˜ áƒ áƒ£áƒ™áƒ˜áƒ¡ áƒ®áƒ”áƒ“áƒ•áƒ˜áƒ¡ áƒáƒ•áƒ¢áƒáƒ›áƒáƒ¢áƒ£áƒ áƒ˜ áƒªáƒ•áƒšáƒ˜áƒšáƒ”áƒ‘áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡
function ChangeView({ center }) {
  const map = useMap();
  map.setView(center, 15);
  return null;
}

const App = () => {
  const [lang, setLang] = useState('ka');
  const [userLoc, setUserLoc] = useState([41.7151, 44.7870]); // Default: áƒ—áƒ‘áƒ˜áƒšáƒ˜áƒ¡áƒ˜
  const [targetLoc, setTargetLoc] = useState(null);
  const [isLocating, setIsLocating] = useState(false);
  const t = translations[lang];

  // 2. GPS áƒšáƒáƒ™áƒáƒªáƒ˜áƒ˜áƒ¡ áƒáƒ›áƒáƒªáƒœáƒáƒ‘áƒ
  const findMyLocation = () => {
    if (navigator.geolocation) {
      setIsLocating(true);
      navigator.geolocation.getCurrentPosition((position) => {
        setUserLoc([position.coords.latitude, position.coords.longitude]);
        setIsLocating(false);
      }, (error) => {
        alert("GPS-áƒ–áƒ” áƒ¬áƒ•áƒ“áƒáƒ›áƒ áƒ£áƒáƒ áƒ§áƒáƒ¤áƒ˜áƒšáƒ˜áƒ");
        setIsLocating(false);
      });
    }
  };

  const handleRoute = (coords) => {
    setTargetLoc(coords);
  };

  return (
    <div style={styles.app}>
      {/* áƒ”áƒœáƒ˜áƒ¡ áƒ“áƒ áƒšáƒáƒ™áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ */}
      <div style={styles.topBar}>
        <div style={styles.langs}>
          {['ka', 'en', 'ru'].map(l => (
            <button key={l} onClick={() => setLang(l)} style={lang === l ? styles.activeLang : styles.langBtn}>{l.toUpperCase()}</button>
          ))}
        </div>
        <button onClick={findMyLocation} style={styles.gpsBtn}>
          {isLocating ? "..." : `ğŸ“ ${t.findMe}`}
        </button>
      </div>

      {/* áƒ áƒ£áƒ™áƒ */}
      <div style={styles.mapContainer}>
        <MapContainer center={userLoc} zoom={13} style={{ height: '100%' }}>
          <ChangeView center={userLoc} />
          <TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" />
          
          <Marker position={userLoc} icon={new L.Icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', iconSize: [25, 41], iconAnchor: [12, 41]})}>
            <Popup>{t.start}</Popup>
          </Marker>

          {targetLoc && (
            <>
              <Marker position={targetLoc} icon={new L.Icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41], iconAnchor: [12, 41]})} />
              <Polyline positions={[userLoc, targetLoc]} color="#3b82f6" weight={5} opacity={0.7} dashArray="10, 10" />
            </>
          )}
        </MapContainer>
      </div>

      {/* áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ˜áƒ¡ áƒáƒáƒœáƒ”áƒšáƒ˜ */}
      <div style={styles.bottomSheet}>
        <h2 style={{fontSize: '18px', marginBottom: '15px'}}>{t.title}</h2>
        
        {/* áƒ¡áƒáƒ¢áƒ”áƒ¡áƒ¢áƒ áƒ›áƒáƒ áƒ¨áƒ áƒ£áƒ¢áƒ”áƒ‘áƒ˜ */}
        <div style={styles.card} onClick={() => handleRoute([41.691, 44.890])}>
          <div style={{...styles.num, background: '#3b82f6'}}>37</div>
          <div style={styles.info}>
            <b>Samgori - Airport</b>
            <span>~12 {t.min}</span>
          </div>
          <button style={styles.goBtn}>{t.go}</button>
        </div>

        <div style={styles.card} onClick={() => handleRoute([41.721, 44.760])}>
          <div style={{...styles.num, background: '#10b981'}}>55</div>
          <div style={styles.info}>
            <b>Varketili - City Mall</b>
            <span>~5 {t.min}</span>
          </div>
          <button style={styles.goBtn}>{t.go}</button>
        </div>
      </div>
    </div>
  );
};

const styles = {
  app: { fontFamily: 'sans-serif', height: '100vh', display: 'flex', flexDirection: 'column', background: '#f8f9fa' },
  topBar: { padding: '15px', display: 'flex', justifyContent: 'space-between', background: '#fff' },
  langs: { display: 'flex', gap: '5px' },
  langBtn: { border: '1px solid #ddd', padding: '5px 8px', borderRadius: '5px', background: 'none' },
  activeLang: { background: '#3b82f6', color: '#fff', border: 'none', padding: '5px 8px', borderRadius: '5px' },
  gpsBtn: { background: '#000', color: '#fff', border: 'none', padding: '8px 12px', borderRadius: '10px', cursor: 'pointer' },
  mapContainer: { flex: 2, borderBottomLeftRadius: '25px', borderBottomRightRadius: '25px', overflow: 'hidden' },
  bottomSheet: { flex: 1.5, padding: '20px', overflowY: 'auto' },
  card: { display: 'flex', alignItems: 'center', background: '#fff', padding: '15px', borderRadius: '16px', marginBottom: '10px', boxShadow: '0 4px 12px rgba(0,0,0,0.05)' },
  num: { width: '40px', height: '40px', borderRadius: '10px', color: '#fff', display: 'flex', justifyContent: 'center', alignItems: 'center', fontWeight: 'bold', marginRight: '15px' },
  info: { flex: 1, display: 'flex', flexDirection: 'column' },
  goBtn: { background: '#eef2ff', color: '#3b82f6', border: 'none', padding: '10px 15px', borderRadius: '10px', fontWeight: '600' }
};

export default App;

